<link rel="import" href="../polymer/polymer.html">

<dom-module id="fort-resource" attributes="auto auth url data headers no-cache xhr">
  <script>
    (function ()
    {
      var resourceCache = {};
      Polymer(
        {
          is:         'fort-resource',
          properties: {
            auto:    {type: Boolean, value: false},
            auth:    {type: Boolean, value: false},
            noCache: {type: Boolean, value: false},
            url:     {type: String},
            headers: {type: Object, value: {}},
            data:    {type: String, readOnly: true, notify: true},
            xhr:     {type: String, readOnly: true, notify: true}
          },
          observers:  ['_updateResource(auto,noCache,url,headers)'],
          attached:   function ()
                      {
                        document.addEventListener(this._NOTIFY_EVENT_NAME, this._resourceUpdated.bind(this));
                      },

          _resourceUpdated: function (e)
                            {
                              var key = this._cacheKey();
                              if(key && e.detail.key == key)
                              {
                                this._setExportsFromStruct(e.detail);
                              }
                            },

          update: function (noCache)
                  {
                    this._updateResource(true, noCache);
                  },

          _setExportsFromStruct: function (dataStruct)
                                 {
                                   if(this.xhr !== dataStruct.xhr)
                                   {
                                     this._setPendingProperty('xhr', dataStruct.xhr);
                                   }
                                   if(this.data !== dataStruct.data)
                                   {
                                     this._setPendingProperty('data', dataStruct.data);
                                   }
                                   this._invalidateProperties();
                                 },

          _updateResource: function (request, noCache)
                           {
                             if(request && this.url)
                             {
                               var key = this._cacheKey();
                               if(!noCache && resourceCache[key])
                               {
                                 this._setExportsFromStruct(resourceCache[key]);
                               }
                               else
                               {
                                 this._triggerRequest();
                               }
                             }
                             else
                             {
                               this._setExportsFromStruct(this._PENDING_STRUCT);
                             }
                           },

          _triggerRequest: function ()
                           {
                             var self = this, key = self._cacheKey(), oReq = new XMLHttpRequest();
                             if(!resourceCache[key])
                             {
                               resourceCache[key] = this._PENDING_STRUCT;
                             }
                             else
                             {
                               resourceCache[key].pending = true;
                             }
                             oReq.addEventListener(
                               "load", function ()
                               {
                                 if(this.status == '200')
                                 {
                                   var data = null;
                                   switch(this.getResponseHeader('content-type'))
                                   {
                                     case 'application/json':
                                       data = JSON.parse(this.responseText);
                                       break;
                                     default:
                                       data = this.responseText;
                                       break;
                                   }
                                   resourceCache[key] = {key: key, xhr: this, data: data};
                                   document.dispatchEvent(
                                     new CustomEvent(
                                       self._NOTIFY_EVENT_NAME, {detail: resourceCache[key]}
                                     )
                                   );
                                 }
                               }
                             );
                             oReq.open('GET', this.url);
                             if(this.headers)
                             {
                               var keys = Object.keys(this.headers);
                               for(var idx in keys)
                               {
                                 if(keys.hasOwnProperty(idx))
                                 {
                                   oReq.setRequestHeader(keys[idx], this.headers[keys[idx]]);
                                 }
                               }
                             }
                             oReq.withCredentials = Boolean(this.auth);
                             oReq.send();
                           },

          _cacheKey: function ()
                     {
                       if(this.url)
                       {
                         return JSON.stringify([this.url, this.headers]);
                       }
                       return null;
                     },

          _NOTIFY_EVENT_NAME: 'fortifi-resource-updated',
          _PENDING_STRUCT:    {key: null, xhr: null, data: null, pending: true}
        }
      );
    }());
  </script>
</dom-module>
